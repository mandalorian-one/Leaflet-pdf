!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("jspdf"),require("dom-to-image-more"),require("changedpi")):"function"==typeof define&&define.amd?define(["exports","jspdf","dom-to-image-more","changedpi"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).Leaflet=t.Leaflet||{},t.Leaflet.ImagePdf={}),null,t.domtoimage,t.changedpi)}(this,(function(t,e,i,n){"use strict";function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e,i){return e&&function(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,l(n.key),n)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function s(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=c(t))||e){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,r=!0,s=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return r=t.done,t},e:function(t){s=!0,a=t},f:function(){try{r||null==i.return||i.return()}finally{if(s)throw a}}}}function h(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,o,a,r,s=[],h=!0,l=!1;try{if(a=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;h=!1}else for(;!(h=(n=a.call(i)).done)&&(s.push(n.value),s.length!==e);h=!0);}catch(t){l=!0,o=t}finally{try{if(!h&&null!=i.return&&(r=i.return(),Object(r)!==r))return}finally{if(l)throw o}}return s}}(t,e)||c(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t,"string");return"symbol"==typeof e?e:e+""}function p(t){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p(t)}function c(t,e){if(t){if("string"==typeof t)return o(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?o(t,e):void 0}}function u(t,e,i,n){return[Math.ceil((e.x-t.x)/i),Math.ceil((e.y-t.y)/n)]}function g(t,e,i,n){for(var o=[],a=h(u(t,e,i,n),2),r=a[0],s=a[1],l=t.x,p=t.y,c=0;c<s;c++)for(var g=0;g<r;g++){var m=l+g*i,f=p+c*n;o.push(new d(L.point(m,f),L.point(m+i,f+n)))}return o}function m(t,e,i,n){var o,a=new d(t[n],t[n]),r=void 0,s=0,l=0;for(l=n+1;l<t.length&&void 0===r;l++){var p=a.extend(t[l]);if(o=new f(t[l-1],t[l]),p.isSmallerThan(e,i))a=p;else{var c=h(a.extendBounded(o,e,i),2);a=c[0],r=c[1],o=new f(t[l-1],r)}s+=o.length()}return[a=new d(L.point(0,0),L.point(e,i)).center(a.middle),l,r,s]}var d=function(){function t(e,i){a(this,t),this.min=e,this.max=i}return r(t,[{key:"xmin",get:function(){return this.min.x}},{key:"ymin",get:function(){return this.min.y}},{key:"xmax",get:function(){return this.max.x}},{key:"ymax",get:function(){return this.max.y}},{key:"corner1",get:function(){return L.point(this.xmin,this.ymin)}},{key:"corner2",get:function(){return L.point(this.xmax,this.ymin)}},{key:"corner3",get:function(){return L.point(this.xmax,this.ymax)}},{key:"corner4",get:function(){return L.point(this.xmin,this.ymax)}},{key:"topleft",get:function(){return this.corner1}},{key:"bottomright",get:function(){return this.corner3}},{key:"middle",get:function(){return this.min.add(this.max).divideBy(2)}},{key:"size",get:function(){return this.max.subtract(this.min)}},{key:"width",get:function(){return this.size.x}},{key:"height",get:function(){return this.size.y}},{key:"center",value:function(e){var i=e.subtract(this.middle);return new t(this.min.add(i),this.max.add(i))}},{key:"extend",value:function(e){return new t(L.point(Math.min(this.xmin,e.x),Math.min(this.ymin,e.y)),L.point(Math.max(this.xmax,e.x),Math.max(this.ymax,e.y)))}},{key:"extendToSquare",value:function(){var e=Math.abs(this.size.x-this.size.y)/2,i=L.point(this.xmin,this.ymin),n=L.point(this.xmax,this.ymax);return this.size.x>this.size.y?(i.y-=e,n.y+=e):(i.x-=e,n.x+=e),new t(i,n)}},{key:"extendBounded",value:function(e,i,n){var o,a=e.displacement;a.x>=0&&a.y>=0?o=new t(L.point(this.xmin,this.ymin),L.point(this.xmin+i,this.ymin+n)):a.x<0&&a.y>=0?o=new t(L.point(this.xmax-i,this.ymin),L.point(this.xmax,this.ymin+n)):a.x<0&&a.y<0?o=new t(L.point(this.xmax-i,this.ymax-n),L.point(this.xmax,this.ymax)):a.x>0&&a.y<0&&(o=new t(L.point(this.xmin,this.ymax-n),L.point(this.xmin+i,this.ymax)));var r=o.intersection(e);return console.assert(void 0!==r,"segment-rectangle intersection test failed"),[this.extend(o.intersection(e)),r]}},{key:"pad",value:function(e){return new t(this.min.subtract(L.point(e,e)),this.max.add(L.point(e,e)))}},{key:"scale",value:function(e){return new t(this.min.multiplyBy(e),this.max.multiplyBy(e))}},{key:"isSmallerThan",value:function(t,e){return this.size.x<=t&&this.size.y<=e}},{key:"intersection",value:function(t){for(var e=new f(this.corner1,this.corner2),i=0,n=[e,new f(this.corner2,this.corner3),new f(this.corner3,this.corner4),new f(this.corner4,this.corner1)];i<n.length;i++){var o=n[i],a=t.intersection(o);if(void 0!==a&&(a.x!=e.p1.x||a.y!=e.p1.y))return a}}}])}(),f=function(){return r((function t(e,i){a(this,t),this.p1=e,this.p2=i}),[{key:"displacement",get:function(){return this.p2.subtract(this.p1)}},{key:"intersection",value:function(t){var e=this,i=e.p1.x,n=e.p1.y,o=e.p2.x,a=e.p2.y,r=t.p1.x,s=t.p1.y,h=t.p2.x,l=t.p2.y,p=(i-o)*(s-l)-(n-a)*(r-h),c=((i-r)*(s-l)-(n-s)*(r-h))/p,u=((o-i)*(n-s)-(a-n)*(i-r))/p;if(0!==p&&c>=0&&c<=1&&u>=0&&u<=1){var g=i+c*(o-i),m=n+c*(a-n);return L.point(g,m)}}},{key:"length",value:function(){var t=this.p2.x-this.p1.x,e=this.p2.y-this.p1.y;return Math.pow(Math.pow(t,2)+Math.pow(e,2),.5)}}])}();var v="image",y="page",x="tile",b={width:"100vw",height:"100vh",background:"white","z-index":950,position:"fixed",top:"0px",left:"0px","justify-content":"center","align-items":"center"};L.Control.ImagePdf=L.Control.extend({options:{pageFormat:"A4",pageOrientation:0,pageMargin:10,areaPadding:10,pagingMethod:"pages",scale:5e4,pageCount:1,dpi:300,maxZoom:null,outputFileName:"map.pdf",downloadOnFinish:!1,tilesLoadingTimeout:1e4,imageFormat:"jpeg",imagePixelRatio:1,showProgressSplashScreen:!0,progressSplashScreenStyle:b,rectanglePreviewStyle:{stroke:!0,weight:1,opacity:1,color:"gray",fillColor:"gray",fillOpacity:.2},pdfFontSize:15,pdfPrintGraticule:!0,pdfPrintScaleMeter:!0,pdfSheetPageNumber:{position:"bottomright"},pdfSheetAttribution:{position:"topleft",text:"Created with Leaflet.ImagePdf"},pdfDocumentProperties:{creator:"Leaflet.ImagePdf"},excludeNodesWithCSS:["div.leaflet-control-container","div.leaflet-control","div.pdf-progress-plug"],pdfPageCb:null,nodeFilterCb:null,debug:!1},initialize:function(t,e){e&&L.setOptions(this,e),this.options.progressSplashScreenStyle=Object.assign({},b,this.options.progressSplashScreenStyle),this.pixelRatio=this.options.imagePixelRatio||1,this.baseImageDpi=72,this.map=t,this.area=null,this.pageFormats=this.pageSizes(),this.pageOrientations=[{name:"Portrait",value:0},{name:"Landscape",value:1},{name:"Auto",value:2}],this.pageSize={width:0,height:0},this.status=0,this.savedMapState=null,this.pagesToPrint=[],this.rectGroup=L.layerGroup(),this.options.debug&&(this.debugRectGroup=L.layerGroup(),this.debugRectGroup.addTo(t),this.debugRectStyle={stroke:!0,weight:1,opacity:.8,color:"green",fillColor:"green",fillOpacity:.2}),this.downloadLink=document.createElement("a"),Object.assign(this.downloadLink.style,{display:"none"}),this.css=document.createElement("style"),this.css.disabled=!0,document.head.appendChild(this.css),this.css.sheet.insertRule(".leaflet-tile-container > img {opacity: 1 !important;}",0),this.progressDiv=document.createElement("div"),Object.assign(this.progressDiv,{className:"pdf-progress-plug"}),Object.assign(this.progressDiv.style,this.options.progressSplashScreenStyle,{display:"none"}),this.map._container.append(this.progressDiv),this.setScale(this.options.scale),this.setImageFormat(this.options.imageFormat),this.setRectPreviewStyle(this.options.rectanglePreviewStyle),this.setPageFormat(this.options.pageFormat),this.setPageOrientation(this.options.pageOrientation),this.setPageMargin(this.options.pageMargin),this.setPagesToPrint([]),this.setPageCount(this.options.pageCount)},destroy:function(){this.hideImageRegions(),this.map.removeLayer(this.rectGroup),this.map._container.remove(this.progressDiv)},pageSizes:function(){for(var t=[],e=0,i=0,n=0;n<=6;n++)e=Math.floor(841/Math.pow(2,n/2)),i=Math.floor(1189/Math.pow(2,n/2)),t.push({name:"A".concat(n),width:e,height:i});for(var o=0;o<=6;o++)e=Math.floor(1e3/Math.pow(2,o/2)),i=Math.floor(1414/Math.pow(2,o/2)),t.push({name:"B".concat(o),width:e,height:i});return t},_orientedPageSize:function(){var t=this.pageSize.width,e=this.pageSize.height;if(1===this.pageOrientation){var i=t;t=e,e=i}return{width:t,height:e}},_pageData:function(t,e,i){var n={sPaper:1,sWorld:null!=t?t:this.scale,wmmPaper:e,hmmPaper:i,pmmPaper:this.pageMargin,pmmArea:this.options.areaPadding,regionCenter:this.area.getCenter(),dimensionsAtCurrentZoom:{},dimensions:{},targetZoom:0},o=1/(n.sPaper/n.sWorld),a=n.wmmPaper*o,r=n.hmmPaper*o,s=n.pmmPaper*o,h=n.pmmArea*o,l={wpx:this.metersToPixels(a/1e3,n.regionCenter),hpx:this.metersToPixels(r/1e3,n.regionCenter),ppx:this.metersToPixels(s/1e3,n.regionCenter),appx:this.metersToPixels(h/1e3,n.regionCenter),dpi:Math.round(this.scaleToDPI(n.sWorld))};return n.dimensionsAtCurrentZoom=l,n.targetScale=this.options.dpi/l.dpi,Object.assign(n,this._calcTargetZoomAndScale(n.targetScale,parseInt)),n.dpi=n.dimensionsAtCurrentZoom.dpi/n.scaleToTargetZoom,n.dimensions={wpx:Math.floor(l.wpx/n.scaleToTargetZoom),hpx:Math.floor(l.hpx/n.scaleToTargetZoom),ppx:Math.floor(l.ppx/n.scaleToTargetZoom),appx:Math.floor(l.appx/n.scaleToTargetZoom),dpi:n.dpi},n},computeScaleAccordingPageCount:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;t*=1;var e=this._orientedPageSize(),i=this.area instanceof L.LatLngBounds?this.area:this.area.getBounds(),n=this.map.project(i.getNorthWest()),o=this.map.project(i.getSouthEast()),a=o.x-n.x,r=o.y-n.y,s=this._pageData(this.scale,e.width,e.height),l=Math.ceil(s.sPaper*this.pixelsToMeters(a,s.regionCenter)*1e3/(s.wmmPaper-2*s.pmmPaper-2*s.pmmArea)),p=Math.ceil(s.sPaper*this.pixelsToMeters(r,s.regionCenter)*1e3/(s.hmmPaper-2*s.pmmPaper-2*s.pmmArea)),c=Math.max(l,p);if(this.options.debug){var g=[this.map.unproject(n),this.map.unproject(o)];L.rectangle(g,this.debugRectStyle).addTo(this.debugRectGroup)}var m=this._rectanglesEvaluationMethod(this.area),d=function(t){return 0};if(1===t&&2===m)return c;1===m?d=function(t){var i=this._pageData(t,e.width,e.height).dimensionsAtCurrentZoom,a=h(u(n.subtract([i.appx,i.appx]),o.add([i.appx,i.appx]),i.wpx-2*i.ppx,i.hpx-2*i.ppx),2);return a[0]*a[1]}.bind(this):2===m&&(d=function(t){var i=this._pageData(t,e.width,e.height).dimensionsAtCurrentZoom;return this._getRouteRectangles(this.area,i.wpx,i.hpx,i.ppx,i.appx,this.pageOrientation).length}.bind(this));for(var f=0,v=c,y=-v/2,x=0;y>10||y<-10;){var b=!1;f++;var w=d(v);if(w>t?b=y<0:w<t?b=y>0:(x=v,y=-1*Math.abs(y)),b&&(y=-y/2),v+y<1&&(y/=2),v+=y,f>1e3||0===w){console.error("something got wrong, to much iterations");break}}return x>0&&(v=x),this.options.debug&&console.log("computeScale iterations: ".concat(f)),Math.ceil(v)},_rectanglesEvaluationMethod:function(t){return t instanceof L.LatLngBounds||t instanceof L.Polygon||t instanceof L.Polyline&&this.isPagesPaging()&&1==this.pageCount?1:t instanceof L.Polyline?2:(console.log("unknown geometry type"),0)},calcPdfPages:function(){if(!this.area)return null;if(this.area instanceof L.Polyline&&!this.area._map)return null;this.options.debug&&this.debugRectGroup.clearLayers();var t=this.scale;this.isPagesPaging()&&(t=this.computeScaleAccordingPageCount(this.pageCount));var e=this._orientedPageSize(),i=this._pageData(t,e.width,e.height);i.rectsAtCurrentZoom=[],i.rects=[],i.images=[];var n=this._rectanglesEvaluationMethod(this.area),o=1===n?this._getBoxRectangles.bind(this):2===n?this._getRouteRectangles.bind(this):function(){return[]},a=i.dimensionsAtCurrentZoom;i.rectsAtCurrentZoom=o(this.area,a.wpx,a.hpx,a.ppx,a.appx,this.pageOrientation);for(var r=0;r<i.rectsAtCurrentZoom.length;r++){var s=i.rectsAtCurrentZoom[r].rotated;i.rectsAtCurrentZoom[r]=i.rectsAtCurrentZoom[r].pad(a.ppx);var h=i.rectsAtCurrentZoom[r].scale(1/i.scaleToTargetZoom);i.rectsAtCurrentZoom[r].rotated=s,h.rotated=s,i.rects.push(h)}if(i.pageCount=i.rects.length,i.pagesToPrint=[],this.pagesToPrintDefined.length>0)for(var l=0;l<i.rects.length;l++)this.pagesToPrintDefined.includes(l)&&i.pagesToPrint.push(l);else for(var p=0;p<i.rects.length;p++)i.pagesToPrint.push(p);return i.pagesToPrintCount=i.pagesToPrint.length,i},calcImages:function(t,e,i){if(!this.area)return null;if(this.area instanceof L.Polyline&&!this.area._map)return null;var n=this.area instanceof L.LatLngBounds?this.area:this.area.getBounds(),o=new d(this.map.project(n.getNorthWest()),this.map.project(n.getSouthEast())),a=t/Math.max(o.width,o.height),r=e/a;o=o.pad(r),i&&(o=o.extendToSquare());var s=g(o.topleft,o.bottomright,o.width,o.height);1!==s.length&&console.error("pdf:image:something got wrong with rectangle evaluation");var h={wpx:o.width,hpx:o.height,aapx:e/a},l={dimensionsAtCurrentZoom:h,targetScale:a=t/Math.max(h.wpx,h.hpx),targetZoom:0,rectsAtCurrentZoom:s,rects:[]};Object.assign(l,this._calcTargetZoomAndScale(a));for(var p=0;p<l.rectsAtCurrentZoom.length;p++)l.rects[p]=l.rectsAtCurrentZoom[p].scale(1/l.scaleToTargetZoom);return l.dimensions={wpx:Math.floor(h.wpx/l.scaleToTargetZoom),hpx:Math.floor(h.hpx/l.scaleToTargetZoom),appx:Math.floor(h.appx/l.scaleToTargetZoom)},l},_calcTargetZoomAndScale:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Math.ceil,i=this.maxZoom?"function"==typeof this.maxZoom?this.maxZoom():this.maxZoom:this.map.getMaxZoom(),n=Math.min(i,e(this.map.getScaleZoom(t,this.map.getZoom())));return{targetZoom:n,scaleToTargetZoom:this.map.getZoomScale(this.map.getZoom(),n)}},showPdfPages:function(t){return null===this.area||0!==this.status?(console.error("pdf: pdf creating is already in progress"),null):(t||(t=this.calcPdfPages()),t?this._showRectangles(t.rectsAtCurrentZoom,t.dimensionsAtCurrentZoom.ppx):this.hideImageRegions(),t)},showImageRegions:function(t){return null===this.area||0!==this.status?(console.error("pdf: is already in progress"),null):t?(this._showRectangles(t.rectsAtCurrentZoom,t.dimensionsAtCurrentZoom.aapx),t):void this.hideImageRegions()},hideImageRegions:function(){this.rectGroup.clearLayers()},_lockMap:function(){this.savedMapState={width:this.map.getContainer().style.width,height:this.map.getContainer().style.height,center:this.map.getCenter(),zoom:this.map.getZoom(),imageRectangles:!!this.rectGroup._map,containerOverflow:this.map._container.parentElement.style.overflow},this.map.removeLayer(this.rectGroup),this.options.debug&&this.debugRectGroup.clearLayers(),this.options.showProgressSplashScreen&&(Object.assign(this.progressDiv.style,{display:"flex",height:window.visualViewport.height+".px",width:window.visualViewport.width+".px",position:"fixed",top:0,left:0}),this.map._container.parentElement.style.overflow="hidden"),this._disableInput(),this.css.disabled=!1},_restoreMap:function(){this.map.getContainer().style.width=this.savedMapState.width,this.map.getContainer().style.height=this.savedMapState.height,this.map.setView(this.savedMapState.center,this.savedMapState.zoom,{animate:!1}),this.savedMapState.imageRectangles&&this.map.addLayer(this.rectGroup),this.map._container.parentElement.style.overflow=this.savedMapState.containerOverflow,this.map.invalidateSize(),this.progressDiv.style.display="none",this._enableInput(),this.css.disabled=!0,this.status=0},_disableInput:function(){this.map.boxZoom.disable(),this.map.doubleClickZoom.disable(),this.map.dragging.disable(),this.map.keyboard.disable(),this.map.scrollWheelZoom.disable(),this.map.tapHold&&this.map.tapHold.disable(),this.map.touchZoom.disable()},_enableInput:function(){this.map.boxZoom.enable(),this.map.doubleClickZoom.enable(),this.map.dragging.enable(),this.map.keyboard.enable(),this.map.scrollWheelZoom.enable(),this.map.tapHold&&this.map.tapHold.enable(),this.map.touchZoom.enable()},createPdf:function(){if(0!==this.status)return!1;var t=this.calcPdfPages();if(!t)return!1;this.status=1,this.fireStarted(t),this._lockMap(),document.addEventListener("pdf:imagesCompleted",this._createPdf.bind(this,t),{once:!0}),this._createImages(t.rects,t.pagesToPrint,t.targetZoom,this.imageFormat)},createImage:function(t,e,i){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(0!==this.status)return!1;var o=function(t){this._restoreMap(),this.fireFinish(t)}.bind(this),a=this.calcImages(t,e,i);if(!a)return!1;var r=a.rects[0],s=t,h=t;i||(r.width>=r.height?h=Math.round(r.height/(r.width/t)):s=Math.round(r.width/(r.height/t))),this.status=1,this.fireStarted(a),this._lockMap(),document.addEventListener("pdf:imagesCompleted",function(t){var e,i,a,r;t.detail&&t.detail.images&&0!==t.detail.images.length?n?(e=t.detail.images[0],i=s,a=h,r="image/"+this.imageFormat,new Promise((function(t,n){var o=document.createElement("canvas"),s=o.getContext("2d");o.width=i,o.height=a,createImageBitmap(e,{resizeWidth:i,resizeHeight:a,resizeQuality:"high"}).then((function(e){s.drawImage(e,0,0),t(o.toDataURL(r,.9))})).catch((function(t){n(t)}))}))).then(function(t){this._startDownload(t,"jpeg"===this.imageFormat?"jpg":this.imageFormat),o(t)}.bind(this)).catch((function(t){console.error(t),o()})):(this._startDownload(t.detail.images[0],"jpeg"===this.imageFormat?"jpg":this.imageFormat),o(t.detail.images[0])):o()}.bind(this),{once:!0}),this._createImages([r],null,a.targetZoom,n?"blob":this.imageFormat)},abort:function(){1===this.status&&(this.status=2)},_createPdf:function(t,e){var i=e.detail?e.detail.images:[],n=null,o=function(){this._restoreMap(),this.fireFinish(n)}.bind(this);if(2!==this.status){i&&i.length===t.pagesToPrintCount||(console.log("pdf: images count is not equal rects count"),o());for(var a=function(t,e,i){if(t&&i&&i.text&&""!==i.text&&i.position){var n=e[0],o=e[1],a=i.position,r=i.text,s=0,h=0,l={};if("topleft"===a)s=5,h=5,l={align:"left",baseline:"top"};else if("topright"===a)s=n-5,h=5,l={align:"right",baseline:"top"};else if("bottomleft"===a)s=5,h=o-5,l={align:"left",baseline:"bottom"};else{if("bottomright"!==a)return void console.warn("pdf: unknown text position");s=n-5,h=o-5,l={align:"right",baseline:"bottom"}}t.text(r,s,h,l)}},r=null,s=0;s<t.pagesToPrint.length;s++){var h=t.rects[t.pagesToPrint[s]];this.fireProgress(y,s,t.pagesToPrint.length,h);var l=void 0,p=void 0;h.rotated?(l=t.hmmPaper,p=t.wmmPaper):(l=t.wmmPaper,p=t.hmmPaper);var c=l>p?"landscape":"portrait";try{var u=[l,p];null==r?((r=new jspdf.jsPDF({format:u,orientation:c,compress:!0})).setFontSize(this.options.pdfFontSize),null!==this.options.pdfDocumentProperties&&Object.keys(this.options.pdfDocumentProperties).length>0&&r.setDocumentProperties(this.options.pdfDocumentProperties)):r.addPage([l,p],c),r.addImage(i[s],this.imageFormat,0,0,l,p,void 0,"FAST"),a(r,u,this.options.pdfSheetAttribution),a(r,u,Object.assign({text:"Page ".concat(t.pagesToPrint[s]+1," of ").concat(t.pageCount)},this.options.pdfSheetPageNumber)),this.options.pdfPageCb&&"function"==typeof this.options.pdfPageCb&&this.options.pdfPageCb(r,t.pagesToPrint[s])}catch(t){console.error(t),this.status=2;break}}2!==this.status?(n=r.output("blob",{filename:this._fixFileExt(this.options.outputFileName,"pdf")}),this._startDownload(n,"pdf"),o()):o()}else o()},_createImages:function(t,e,o,a){var r=[];if(!e){e=[];for(var l=0;l<t.length;l++)e.push(l)}var p=function(){document.removeEventListener("pdf:documentTilesLoaded",g),document.removeEventListener("pdf:startNextImage",m),document.dispatchEvent(new CustomEvent("pdf:imagesCompleted",{detail:{images:r}}))}.bind(this),c=function(t){if(t.matches){var e,i=s(this.options.excludeNodesWithCSS);try{for(i.s();!(e=i.n()).done;){var n=e.value;if(t.matches(n))return!1}}catch(t){i.e(t)}finally{i.f()}}return!this.options.nodeFilterCb||"function"!=typeof this.options.nodeFilterCb||this.options.nodeFilterCb(t)}.bind(this),u=function(){return new Promise((function(t,e){e("image generator isn't implemented")}))};"jpeg"===a?u=i.toJpeg:"png"===a?u=i.toPng:"blob"===a&&(u=i.toBlob);var g=function(i){var o=i.detail.i,a=t[e[o]],s=this.pixelRatio,h={width:Math.round(a.width)*s,height:Math.round(a.height)*s,style:{transform:"scale("+s+")",transformOrigin:"top left"},filter:c};u(this.map.getContainer(),h).then(function(t){2!==this.status?(s>1&&t instanceof Blob?n.changeDpiBlob(t,this.baseImageDpi*this.pixelRatio).then((function(t){r.push(t),document.dispatchEvent(new CustomEvent("pdf:startNextImage",{detail:{i:o+1}}))})):s>1&&(t=n.changeDpiDataUrl(t,this.baseImageDpi*this.pixelRatio)),r.push(t),document.dispatchEvent(new CustomEvent("pdf:startNextImage",{detail:{i:o+1}}))):p()}.bind(this)).catch(function(t){console.error("_createImages:domtoimage: got error",t),this.fireAborted("internal error"),this.status=2,p()}.bind(this))}.bind(this),m=function(i){try{var n=i.detail.i,a=e[n];if(n===e.length||2===this.status)return void p();var r=(new Date).getTime(),s=t[a];this.fireProgress(v,n,e.length,s);var l=s.width,c=s.height,u=s.middle;if(this.map.getZoom()!==o){var g=this.map.getZoomScale(this.map.getZoom(),o);u=s.scale(g).middle}u=this.map.unproject(u),this.map.getContainer().style.width="".concat(Math.ceil(l),"px"),this.map.getContainer().style.height="".concat(Math.ceil(c),"px"),this.map.invalidateSize(),this.map.setView(u,o,{animate:!1});var m=setInterval(function(){if(2===this.status)return clearInterval(m),void p();var t=h(this._loadedTiles(this.map),3),e=t[0],i=t[1],o=t[2];if(this.options.debug&&console.log("tiles loaded: ".concat(i," from ").concat(e)),this.fireProgress(x,i,e,null),e===i)return clearInterval(m),void document.dispatchEvent(new CustomEvent("pdf:documentTilesLoaded",{detail:{i:n}}));(new Date).getTime()-r>this.options.tilesLoadingTimeout&&(this.options.debug&&console.log("Aborted due to tiles loading timeout of the layer: ".concat(o._url)),this.status=2,this.fireAborted("timeout",o),clearInterval(m),p())}.bind(this),200)}catch(t){console.error("prepareDocumentForImaging: got error",t),this.fireAborted("internal error"),p()}}.bind(this);document.addEventListener("pdf:documentTilesLoaded",g),document.addEventListener("pdf:startNextImage",m),document.dispatchEvent(new CustomEvent("pdf:startNextImage",{detail:{i:0}}))},_loadedTiles:function(t){var e=0,i=0,n=null;for(var o in t._layers){var a=t._layers[o];(a._url||a._mutant)&&(a._level&&(e+=a._level.el.childNodes.length,i+=a._level.el.querySelectorAll("img.leaflet-tile-loaded").length),a._loading&&null===n&&(n=a))}return n||(i=e),[e,i,n]},fireEvent:function(t,e){this.map.fire("imagePdf:"+t,e)},fireStarted:function(t){this.fireEvent("start",t)},fireFinish:function(t){this.fireEvent("finish",{blob:t})},fireProgress:function(t,e,i,n){this.fireEvent("progress",{operation:t,itemNo:e,totalItems:i,item:n})},fireAborted:function(t,e){this.fireEvent("aborted",{reason:t,data:e})},_getAttribution:function(){var t=void 0;return this.map.eachLayer((function(e){void 0===t&&e.getAttribution()&&(t=e.getAttribution().replace(/<[^>]*>/g,""))})),t},pixelsToMeters:function(t,e){var i=this.map.latLngToLayerPoint(e).add(L.point(-t/2,0)),n=this.map.latLngToLayerPoint(e).add(L.point(+t/2,0));return i=this.map.layerPointToLatLng(i),n=this.map.layerPointToLatLng(n),i.distanceTo(n)},metersToPixels:function(t,e){return t/this.pixelsToMeters(1,e)},scaleToDPI:function(t){var e=t,i=this._orientedPageSize(),n=i.width,o=i.height,a=1/(1/e),r=n*a,s=o*a,h=this.area.getCenter();return(this.metersToPixels(r/1e3,h)/(n/25.4)+this.metersToPixels(s/1e3,h)/(o/25.4))/2},DPIToScale:function(t){var e=this._orientedPageSize(),i=e.width,n=e.height,o=t/25.4*i,a=n/i*o;return(1*this.pixelsToMeters(o,this.area.getCenter())*1e3/i+1*this.pixelsToMeters(a,this.area.getCenter())*1e3/n)/2},_showRectangles:function(t,e){this.rectGroup.clearLayers();for(var i=0;i<t.length;i++){var n=t[i],o=n.pad(-e);o=[this.map.unproject(o.min),this.map.unproject(o.max)],n=[this.map.unproject(n.min),this.map.unproject(n.max)],L.rectangle(n,Object.assign({},this.rectPreviewStyle)).addTo(this.rectGroup),L.rectangle(o,Object.assign({},this.rectPreviewStyle,{fill:!1})).addTo(this.rectGroup)}null==this.rectGroup._map&&this.rectGroup.addTo(this.map)},_getBoxRectangles:function(t,e,i,n,o,a){if(null===t)return[];var r=null;return t instanceof L.LatLngBounds&&(r=t),"function"==typeof t.getBounds&&(r=t.getBounds()),r?g(this.map.project(r.getNorthWest()).subtract([o,o]),this.map.project(r.getSouthEast()).add([o,o]),e-2*n,i-2*n):[]},_getRouteRectangles:function(t,e,i,n,o,a){if(null===t||"function"!=typeof t.getLatLngs)return[];var r=t.getLatLngs();if(0===r.length)return[];r[0]instanceof Array&&(r=r[0]);for(var l=r.slice(),p=0;p<l.length;p++)l[p]=this.map.project(l[p]);var c=function(t,e,i,n){for(var o=[],a=[],r=0;;){var s=h(m(t,e,i,r),4),l=s[0],p=s[1],c=s[2],u=s[3];if(n){var g=h(m(t,i,e,r),4),d=g[0],f=g[1],v=g[2],y=g[3];l.rotated=!1,y>u&&(p=f,c=v,u=y,(l=d).rotated=!0)}if(o.push(l),void 0===c)break;a.push(c),t.splice(p,0,c),r=p}return[o,a]}(l,e-2*n,i-2*n,2===a),u=h(c,2),g=u[0],d=u[1];if(this.options.debug){for(var f=0;f<d.length;f++)d[f]=this.map.unproject(d[f]);var v,y=s(d);try{for(y.s();!(v=y.n()).done;){var x=v.value;L.circleMarker(x,{radius:5,stroke:!1,color:"black",opacity:1,fillOpacity:1}).addTo(this.debugRectGroup)}}catch(t){y.e(t)}finally{y.f()}}return g},_fixFileExt:function(t,e){for(var i,n,o=0,a=["jpg","png","pdf"];o<a.length;o++){var r="."+(n=a[o]);if(-1!==(i=t.lastIndexOf(r))){if(i===t.length-r.length)break;i=-1}}return-1!==i?n===e?t:t.substring(0,i)+"."+e:t+"."+e},_startDownload:function(t,e){if(this.options.downloadOnFinish&&t){var i=this._fixFileExt(this.options.outputFileName,e);Object.assign(this.downloadLink,{download:i}),this.downloadLink.href=t instanceof Blob?URL.createObjectURL(t):t,this.downloadLink.click()}},isScalePaging:function(){return"scale"===this.options.pagingMethod},isPagesPaging:function(){return"pages"===this.options.pagingMethod},setMaxZoom:function(t){this.maxZoom=t},setArea:function(t){if("object"===p(t)&&!(t instanceof L.LatLngBounds)&&"function"!=typeof t.getBounds)throw new Error("the area should be instance of LatLngBounds class, or must have getBounds method");this.area=t,t||this.hideImageRegions()},setScale:function(t){this.scale=parseInt(t)},getScale:function(){return this.scale},setPageCount:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;1*t==0&&(t=1),this.pageCount=t},getPageCount:function(){return this.pageCount},setPageOrientation:function(t){var e,i=s(this.pageOrientations);try{for(i.s();!(e=i.n()).done;){var n=e.value;if("function"==typeof t.toLowerCase&&n.name.toLowerCase()===t.toLowerCase())return void(this.pageOrientation=n.value);if(n.value===t)return void(this.pageOrientation=t)}}catch(t){i.e(t)}finally{i.f()}this.pageOrientation=this.options.pageOrientation},setPageMargin:function(t){this.pageMargin=parseInt(t)},getPageMargin:function(){return this.pageMargin},setPagesToPrint:function(t){"object"!==p(t)?this.pagesToPrintDefined=[]:this.pagesToPrintDefined=t.slice()},setPageFormat:function(t){var e=this,i=this.pageFormats.findIndex((function(e){return e.name===t}));-1===i&&(i=this.pageFormats.findIndex((function(t){return t.name===e.options.pageFormat}))),this.pageFormat=this.pageFormats[i],this.pageSize.width=this.pageFormat.width,this.pageSize.height=this.pageFormat.height},setPageSize:function(t,e){t>0&&e>0&&(this.pageSize.width=parseInt(t),this.pageSize.height=parseInt(e),this.pageFormat=null)},getPageFormats:function(){return this.pageFormats},getPageFormat:function(){return this.pageFormat},getPageOrientations:function(){return this.pageOrientations},setImageFormat:function(t){if("jpeg"!=t&&"png"!=t)throw'Invalid image format: "'.concat(t,'"');this.imageFormat=t},setRectPreviewStyle:function(t){t||(t=this.options.rectanglePreviewStyle),this.rectPreviewStyle=Object.assign({},t)}}),L.imagePdf=function(t,e){return new L.Control.ImagePdf(t,e)},t.OpCreatePage=y,t.OpGenerateImage=v,t.OpLoadTiles=x}));
//# sourceMappingURL=Leaflet.ImagePdf.umd.min.js.map
